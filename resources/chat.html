<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline' https:; font-src {{cspSource}} https:; script-src {{cspSource}} 'unsafe-inline';">
    <title>LNIM Chat</title>
    <link rel="stylesheet" href="https://unpkg.com/@vscode/codicons/dist/codicon.css">
    <style>
        body {
            font-family: var(--vscode-font-family);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Header Styles */
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: var(--vscode-sideBar-background);
            border-bottom: 1px solid var(--vscode-widget-border);
        }
        #header h3 {
            margin: 0;
            font-size: 14px;
        }
        .icon-btn {
            cursor: pointer;
            color: var(--vscode-icon-foreground);
            background: none;
            border: none;
            padding: 2px;
        }
        .icon-btn:hover {
            color: var(--vscode-foreground);
        }
        #header-right {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .icon-btn .codicon {
            font-size: 16px;
        }

        /* Chat Box Styles */
        #chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        /* Message Styles */
        .message-container {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            margin-bottom: 8px;
        }
        .message-container.self {
            align-self: flex-end;
            align-items: flex-end;
        }
        .message-container.other {
            align-self: flex-start;
            align-items: flex-start;
        }
        
        .nickname {
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            margin-bottom: 2px;
            padding: 0 4px;
        }
        
        .message {
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
            position: relative;
            line-height: 1.4;
        }
        .message-container.self .message {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border-bottom-right-radius: 2px;
        }
        .message-container.other .message {
            background-color: var(--vscode-list-hoverBackground);
            color: var(--vscode-foreground);
            border-bottom-left-radius: 2px;
        }

        /* Timestamp Styles */
        .timestamp {
            align-self: center;
            font-size: 11px;
            color: var(--vscode-descriptionForeground);
            background-color: var(--vscode-textBlockQuote-background);
            padding: 2px 8px;
            border-radius: 10px;
            margin: 10px 0;
        }

        /* Input Area Styles */
        #input-container {
            flex-shrink: 0;
            padding: 10px;
            border-top: 1px solid var(--vscode-widget-border);
            background-color: var(--vscode-editor-background);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #message-input {
            width: 100%;
            min-height: 40px;
            max-height: 150px;
            padding: 8px;
            box-sizing: border-box;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 4px;
            overflow-y: auto;
            outline: none;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        #message-input:empty:before {
            content: attr(placeholder);
            color: var(--vscode-input-placeholderForeground);
        }
        #mention-suggest {
            position: absolute;
            left: 10px;
            bottom: 56px;
            width: calc(100% - 20px);
            max-height: 240px;
            overflow-y: auto;
            background: var(--vscode-editorWidget-background, var(--vscode-editor-background));
            border: 1px solid var(--vscode-widget-border);
            border-radius: 4px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            display: none;
            z-index: 120;
        }
        .mention-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            font-size: 12px;
            color: var(--vscode-foreground);
            cursor: pointer;
        }
        .mention-item .codicon {
            font-size: 14px;
            color: var(--vscode-icon-foreground);
        }
        .mention-item:hover,
        .mention-item.active {
            background: var(--vscode-list-hoverBackground);
        }
        .mention-item .type {
            margin-left: auto;
            color: var(--vscode-descriptionForeground);
            font-size: 11px;
        }
        .mention-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35em;
            padding: 0 0.45em;
            margin: 0 0.2em;
            height: 1.4em;
            border-radius: 0.75em;
            background: var(--vscode-textBlockQuote-background);
            border: 1px solid var(--vscode-widget-border);
            color: var(--vscode-foreground);
            line-height: 1;
            user-select: none;
            cursor: pointer;
            vertical-align: middle;
        }
        .mention-tag .codicon {
            font-size: 0.9em;
            color: var(--vscode-icon-foreground);
            line-height: 1;
        }
        .mention-tag .label {
            font-size: 1em;
            line-height: 1;
            display: inline-block;
        }
        .mention-tag .close {
            cursor: pointer;
            color: var(--vscode-descriptionForeground);
            line-height: 1;
            align-self: center;
        }
        .mention-tag .close:hover {
            color: var(--vscode-errorForeground);
        }

        /* Settings Overlay Styles */
        #settings-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: flex-start;
            z-index: 100;
            padding-top: 50px;
        }
        #settings-panel {
            background-color: var(--vscode-editor-background);
            padding: 20px;
            border: 1px solid var(--vscode-widget-border);
            border-radius: 5px;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 6px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            box-sizing: border-box;
        }
        .button-group {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        button {
            padding: 6px 12px;
            border: none;
            cursor: pointer;
            border-radius: 2px;
        }
        #save-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        #cancel-btn {
            background-color: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
        }
        /* Contacts Overlay Styles */
        #contacts-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 16px;
            box-sizing: border-box;
        }
        #contacts-panel {
            background-color: var(--vscode-editorWidget-background, var(--vscode-editor-background));
            padding: 16px;
            border: 1px solid var(--vscode-widget-border);
            border-radius: 5px;
            width: 92%;
            max-width: 520px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        }
        #contacts-panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            border-bottom: 1px solid var(--vscode-widget-border);
            padding-bottom: 6px;
        }
        #contact-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            margin-bottom: 12px;
        }
        #contact-form input {
            padding: 6px;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            box-sizing: border-box;
        }
        #add-contact-btn {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 6px 10px;
            cursor: pointer;
            white-space: nowrap;
        }
        table.contacts {
            width: 100%;
            border-collapse: collapse;
        }
        table.contacts th,
        table.contacts td {
            border: 1px solid var(--vscode-widget-border);
            padding: 6px 8px;
            font-size: 12px;
        }
        table.contacts th {
            background: var(--vscode-sideBar-background);
            text-align: left;
        }
        .danger-btn {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: var(--vscode-textLink-foreground);
            font-size: 12px;
        }
        .danger-btn:hover {
            text-decoration: underline;
            color: var(--vscode-textLink-activeForeground, var(--vscode-textLink-foreground));
        }
    </style>
</head>
<body>
    <div id="header">
        <h3>LNIM Chat</h3>
        <div id="header-right">
            <button class="icon-btn" id="contacts-btn" title="添加联系人">
                <span class="codicon codicon-account"></span>
            </button>
            <button class="icon-btn" id="settings-btn" title="Settings">
                <span class="codicon codicon-gear"></span>
            </button>
        </div>
    </div>

    <div id="contacts-overlay">
        <div id="contacts-panel">
            <h3>联系人</h3>
            <div id="contact-form">
                <input type="text" id="contact-ip" placeholder="IP 地址">
                <input type="text" id="contact-username" placeholder="用户名">
                <button id="add-contact-btn">添加</button>
            </div>
            <table class="contacts">
                <thead>
                    <tr>
                        <th>IP 地址</th>
                        <th>用户名</th>
                        <th style="width:80px;">操作</th>
                    </tr>
                </thead>
                <tbody id="contacts-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="chat-box"></div>

    <div id="input-container">
        <div id="message-input" contenteditable="true" placeholder="Type a message..."></div>
        <div id="mention-suggest"></div>
    </div>

    <div id="settings-overlay">
        <div id="settings-panel">
            <h3>Settings</h3>
            <div class="form-group">
                <label for="nickname">Nickname</label>
                <input type="text" id="nickname" placeholder="Enter your nickname">
            </div>
            <div class="form-group">
                <label for="ip-address">IP Address</label>
                <input type="text" id="ip-address" placeholder="Enter IP address">
            </div>
            <div class="button-group">
                <button id="cancel-btn">Cancel</button>
                <button id="save-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const chatBox = document.getElementById('chat-box');
        const input = document.getElementById('message-input');
        const settingsOverlay = document.getElementById('settings-overlay');
        const nicknameInput = document.getElementById('nickname');
        const ipInput = document.getElementById('ip-address');
        const contactsOverlay = document.getElementById('contacts-overlay');
        const contactIpInput = document.getElementById('contact-ip');
        const contactUsernameInput = document.getElementById('contact-username');
        const contactsTbody = document.getElementById('contacts-tbody');
        const mentionSuggest = document.getElementById('mention-suggest');

        let currentUserSettings = {
            nickname: 'User',
            ip: ''
        };
        let lastMessageTime = 0;
        let contacts = [];
        let allContacts = [];
        let filesCache = [];
        let foldersCache = [];
        let mentionActive = false;
        let mentionQuery = '';
        let mentionItems = [];
        let mentionIndex = -1;

        // --- Event Listeners ---

        input.addEventListener('keydown', (e) => {
            if (mentionActive) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (mentionItems.length) {
                        mentionIndex = (mentionIndex + 1) % mentionItems.length;
                        renderMention();
                    }
                    return;
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (mentionItems.length) {
                        mentionIndex = (mentionIndex - 1 + mentionItems.length) % mentionItems.length;
                        renderMention();
                    }
                    return;
                }
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (mentionIndex >= 0 && mentionIndex < mentionItems.length) {
                        applyMention(mentionItems[mentionIndex]);
                        closeMention();
                        return;
                    }
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    closeMention();
                    return;
                }
            }
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const message = buildMessageText().trim();
                if (message) {
                    sendMessage(message);
                    input.innerHTML = '';
                    closeMention();
                }
                return;
            }
            if (e.key === '@') {
                setTimeout(() => {
                    openMentionIfNeeded();
                }, 0);
            }
            if (e.key === 'Backspace') {
                const sel = window.getSelection();
                if (sel && sel.rangeCount) {
                    const range = sel.getRangeAt(0);
                    if (range.collapsed) {
                        let container = range.startContainer;
                        let offset = range.startOffset;
                        if (container.nodeType === Node.TEXT_NODE) {
                            if (offset === 0) {
                                const prev = container.previousSibling;
                                if (prev && prev.nodeType === Node.ELEMENT_NODE && prev.classList && prev.classList.contains('mention-tag')) {
                                    e.preventDefault();
                                    prev.remove();
                                    return;
                                }
                            }
                        } else if (container.nodeType === Node.ELEMENT_NODE) {
                            const el = container;
                            const prev = el.childNodes[offset - 1];
                            if (prev && prev.nodeType === Node.ELEMENT_NODE && prev.classList && prev.classList.contains('mention-tag')) {
                                e.preventDefault();
                                prev.remove();
                                return;
                            }
                        }
                    }
                }
            }
        });
        input.addEventListener('input', () => {
            if (!mentionActive) {
                openMentionIfNeeded();
                return;
            }
            const q = getCurrentMentionQuery();
            if (q === null) {
                closeMention();
            } else {
                mentionQuery = q;
                filterMention();
            }
        });

        document.getElementById('settings-btn').addEventListener('click', () => {
            // Fill inputs with current settings
            nicknameInput.value = currentUserSettings.nickname;
            ipInput.value = currentUserSettings.ip;
            settingsOverlay.style.display = 'flex';
        });
        document.getElementById('contacts-btn').addEventListener('click', () => {
            contactIpInput.value = '';
            contactUsernameInput.value = '';
            contactsOverlay.style.display = 'flex';
            vscode.postMessage({ type: 'getContacts' });
        });

        document.getElementById('cancel-btn').addEventListener('click', () => {
            settingsOverlay.style.display = 'none';
        });

        document.getElementById('save-btn').addEventListener('click', () => {
            const newSettings = {
                nickname: nicknameInput.value.trim() || 'User',
                ip: ipInput.value.trim()
            };
            vscode.postMessage({ type: 'saveSettings', settings: newSettings });
            // Optimistically update local settings
            currentUserSettings = newSettings;
            settingsOverlay.style.display = 'none';
        });
        document.getElementById('add-contact-btn').addEventListener('click', () => {
            const ip = contactIpInput.value.trim();
            const username = contactUsernameInput.value.trim();
            if (!ip || !username) return;
            vscode.postMessage({ type: 'addContact', contact: { ip, username }});
            contactIpInput.value = '';
            contactUsernameInput.value = '';
        });

        // --- Message Handling ---

        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'updateSettings':
                    currentUserSettings = message.settings;
                    break;
                case 'settingsSaved':
                    currentUserSettings = message.settings;
                    break;
                case 'updateContacts':
                    contacts = message.contacts || [];
                    allContacts = contacts.slice();
                    if (mentionActive) filterMention();
                    renderContacts();
                    break;
                case 'contactsSaved':
                    contacts = message.contacts || [];
                    allContacts = contacts.slice();
                    if (mentionActive) filterMention();
                    renderContacts();
                    break;
                case 'filesAndFolders':
                    filesCache = message.files || [];
                    foldersCache = message.folders || [];
                    if (mentionActive) filterMention();
                    break;
                // Handle other messages like 'receiveMessage' in future
            }
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (settingsOverlay.style.display === 'flex') {
                    settingsOverlay.style.display = 'none';
                }
                if (contactsOverlay.style.display === 'flex') {
                    contactsOverlay.style.display = 'none';
                }
                if (mentionActive) {
                    closeMention();
                }
            }
        });

        function sendMessage(text) {
            const now = Date.now();
            checkAndAddTimestamp(now);
            
            addMessage({
                text: text,
                isSelf: true,
                nickname: currentUserSettings.nickname,
                timestamp: now
            });

            vscode.postMessage({ 
                type: 'sendMessage', 
                value: text,
                timestamp: now,
                nickname: currentUserSettings.nickname
            });
            
            lastMessageTime = now;
        }

        function checkAndAddTimestamp(currentTimestamp) {
            if (currentTimestamp - lastMessageTime > 10 * 60 * 1000) {
                const date = new Date(currentTimestamp);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const div = document.createElement('div');
                div.className = 'timestamp';
                div.textContent = timeString;
                chatBox.appendChild(div);
            }
        }

        function addMessage({ text, isSelf, nickname }) {
            const container = document.createElement('div');
            container.className = 'message-container' + (isSelf ? ' self' : ' other');
            
            const nicknameDiv = document.createElement('div');
            nicknameDiv.className = 'nickname';
            nicknameDiv.textContent = nickname;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            renderMessageContent(messageDiv, text);
            
            container.appendChild(nicknameDiv);
            container.appendChild(messageDiv);
            
            chatBox.appendChild(container);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
        function renderMessageContent(container, text) {
            container.innerHTML = '';
            const parts = text.split(/(\s+)/);
            parts.forEach((part) => {
                if (!part) return;
                if (/^\s+$/.test(part)) {
                    container.appendChild(document.createTextNode(part));
                    return;
                }
                if (part[0] === '@' && part.length > 1) {
                    let name = part.slice(1);
                    let suffix = '';
                    const m = name.match(/^([^\s.,;:!?]+)([.,;:!?]*)$/);
                    if (m) {
                        name = m[1];
                        suffix = m[2];
                    }
                    const item = resolveMentionItem(name);
                    const tag = createMentionTag(item, { closable: false, source: 'message' });
                    container.appendChild(tag);
                    if (suffix) {
                        container.appendChild(document.createTextNode(suffix));
                    }
                } else {
                    container.appendChild(document.createTextNode(part));
                }
            });
        }
        function openMentionIfNeeded() {
            const q = getCurrentMentionQuery();
            if (q === null) {
                closeMention();
                return;
            }
            if (!mentionActive) {
                mentionActive = true;
                mentionIndex = -1;
                vscode.postMessage({ type: 'getContacts' });
                vscode.postMessage({ type: 'getFilesAndFolders' });
            }
            mentionQuery = q;
            filterMention();
        }
        function closeMention() {
            mentionActive = false;
            mentionQuery = '';
            mentionItems = [];
            mentionIndex = -1;
            mentionSuggest.style.display = 'none';
            mentionSuggest.innerHTML = '';
        }
        function getCurrentMentionQuery() {
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return null;
            const text = input.innerText;
            const caret = getCaretCharacterOffsetWithin(input);
            if (caret === null) return null;
            const before = text.slice(0, caret);
            const at = before.lastIndexOf('@');
            if (at === -1) return null;
            if (at > 0) {
                const prev = before.charAt(at - 1);
                if (!/\s/.test(prev)) return null;
            }
            const query = before.slice(at + 1);
            if (/\s/.test(query)) return null;
            return query;
        }
        function filterMention() {
            const q = mentionQuery.toLowerCase();
            const contactItems = (allContacts || []).map(c => ({
                type: 'contact',
                label: c.username,
                value: c.username,
                detail: c.ip
            }));
            const fileItems = (filesCache || []).map(p => ({
                type: 'file',
                label: p,
                value: p
            }));
            const folderItems = (foldersCache || []).map(p => ({
                type: 'folder',
                label: p,
                value: p
            }));
            const combined = contactItems.concat(folderItems).concat(fileItems);
            mentionItems = combined.filter(it => !q || it.label.toLowerCase().includes(q));
            if (mentionItems.length > 0 && mentionIndex === -1) mentionIndex = 0;
            renderMention();
        }
        function renderMention() {
            if (!mentionActive || mentionItems.length === 0) {
                mentionSuggest.style.display = 'none';
                mentionSuggest.innerHTML = '';
                return;
            }
            mentionSuggest.style.display = 'block';
            mentionSuggest.innerHTML = '';
            mentionItems.slice(0, 50).forEach((it, idx) => {
                const div = document.createElement('div');
                div.className = 'mention-item' + (idx === mentionIndex ? ' active' : '');
                const icon = document.createElement('span');
                icon.className = 'codicon ' + (it.type === 'contact' ? 'codicon-account' : it.type === 'folder' ? 'codicon-folder' : 'codicon-file');
                const label = document.createElement('span');
                label.textContent = it.label;
                div.appendChild(icon);
                div.appendChild(label);
                if (it.detail) {
                    const t = document.createElement('span');
                    t.className = 'type';
                    t.textContent = it.detail;
                    div.appendChild(t);
                } else {
                    const t = document.createElement('span');
                    t.className = 'type';
                    t.textContent = it.type;
                    div.appendChild(t);
                }
                div.addEventListener('mouseenter', () => {
                    mentionIndex = idx;
                    renderMention();
                });
                div.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                });
                div.addEventListener('click', () => {
                    applyMention(mentionItems[idx]);
                    closeMention();
                });
                mentionSuggest.appendChild(div);
            });
        }
        function applyMention(item) {
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return;
            let range = sel.getRangeAt(0);
            let container = range.startContainer;
            if (container.nodeType !== Node.TEXT_NODE) {
                const placeholder = document.createTextNode('');
                range.insertNode(placeholder);
                range.setStart(placeholder, 0);
                range.setEnd(placeholder, 0);
                container = placeholder;
            }
            const textNode = container;
            const beforeText = textNode.data.slice(0, range.startOffset);
            const afterText = textNode.data.slice(range.startOffset);
            const atIndex = beforeText.lastIndexOf('@');
            if (atIndex === -1) return;
            if (atIndex > 0) {
                const prevCh = beforeText.charAt(atIndex - 1);
                if (!/\s/.test(prevCh)) return;
            }
            const head = beforeText.slice(0, atIndex);
            textNode.data = head;
            const tag = createMentionTag(item, { closable: true, source: 'input' });
            const space = document.createTextNode(' ');
            const tail = document.createTextNode(afterText);
            if (textNode.nextSibling) {
                textNode.parentNode.insertBefore(tag, textNode.nextSibling);
            } else {
                textNode.parentNode.appendChild(tag);
            }
            tag.parentNode.insertBefore(space, tag.nextSibling);
            space.parentNode.insertBefore(tail, space.nextSibling);
            const newRange = document.createRange();
            newRange.setStart(tail, 0);
            newRange.collapse(true);
            sel.removeAllRanges();
            sel.addRange(newRange);
            input.focus();
        }
        function createMentionTag(item, opts) {
            const span = document.createElement('span');
            span.className = 'mention-tag';
            if (opts && opts.source === 'input') {
                span.setAttribute('contenteditable', 'false');
            }
            span.dataset.type = item.type;
            span.dataset.value = item.value;
            const icon = document.createElement('span');
            icon.className = 'codicon ' + (item.type === 'contact' ? 'codicon-account' : item.type === 'folder' ? 'codicon-folder' : 'codicon-file');
            const label = document.createElement('span');
            label.className = 'label';
            label.textContent = '@' + item.label;
            span.appendChild(icon);
            span.appendChild(label);
            if (opts && opts.closable) {
                const close = document.createElement('span');
                close.className = 'close codicon codicon-close';
                close.title = '移除';
                close.addEventListener('click', (e) => {
                    e.stopPropagation();
                    span.remove();
                });
                span.appendChild(close);
            }
            span.addEventListener('click', (e) => {
                e.stopPropagation();
                vscode.postMessage({
                    type: 'tagClicked',
                    item: { type: item.type, value: item.value, label: item.label }
                });
                if (opts && opts.source === 'input') {
                    input.focus();
                }
            });
            return span;
        }
        function resolveMentionItem(val) {
            const c = (allContacts || []).find(x => x.username === val);
            if (c) return { type: 'contact', value: c.username, label: c.username, detail: c.ip };
            const fldr = (foldersCache || []).find(x => x === val);
            if (fldr) return { type: 'folder', value: fldr, label: fldr };
            const file = (filesCache || []).find(x => x === val);
            if (file) return { type: 'file', value: file, label: file };
            return { type: 'mention', value: val, label: val };
        }
        function buildMessageText() {
            let s = '';
            input.childNodes.forEach((node) => {
                if (node.nodeType === Node.TEXT_NODE) {
                    s += node.nodeValue;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const el = node;
                    if (el.classList && el.classList.contains('mention-tag')) {
                        const v = el.dataset.value || '';
                        s += '@' + v + ' ';
                    } else {
                        s += el.textContent;
                    }
                }
            });
            return s;
        }
        function getCaretCharacterOffsetWithin(element) {
            let caretOffset = 0;
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return null;
            const range = sel.getRangeAt(0);
            const preRange = range.cloneRange();
            preRange.selectNodeContents(element);
            preRange.setEnd(range.endContainer, range.endOffset);
            caretOffset = preRange.toString().length;
            return caretOffset;
        }
        function placeCaretAtEnd(el) {
            el.focus();
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
        function renderContacts() {
            contactsTbody.innerHTML = '';
            contacts.forEach((c) => {
                const tr = document.createElement('tr');
                const tdIp = document.createElement('td');
                const tdUser = document.createElement('td');
                const tdOps = document.createElement('td');
                tdIp.textContent = c.ip;
                tdUser.textContent = c.username;
                const delBtn = document.createElement('button');
                delBtn.className = 'danger-btn';
                delBtn.textContent = '删除';
                delBtn.addEventListener('click', () => {
                    vscode.postMessage({ type: 'deleteContact', contact: c });
                });
                tdOps.appendChild(delBtn);
                tr.appendChild(tdIp);
                tr.appendChild(tdUser);
                tr.appendChild(tdOps);
                contactsTbody.appendChild(tr);
            });
        }

        // --- Initialization ---
        
        // Request initial settings
        vscode.postMessage({ type: 'getSettings' });

    </script>
</body>
</html>
